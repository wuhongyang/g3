<?phpclass act {    private $db = null;    private $mongodb = null;    public function __construct($dataGroupId){        $this->mongodb = domain::main()->GroupDBConn('mongo', $dataGroupId);    }    public function __destruct(){        unset($this->mongodb);    }    public function actList($array){        $query_condition = array();        if($array['uin_type'] == 1 && $array['select_type'] == 1){            $query_condition['Uin'] = intval($array['uin']);        }        if($array['uin_type'] == 2 && $array['select_type'] == 1){            $query_condition['TargetUin'] = intval($array['uin']);        }        if($array['ParentId'] && $array['select_type'] == 2){            $query_condition['ParentId'] = intval($array['ParentId']);        }        elseif($array['CaseId'] && $array['select_type'] == 2){            $query_condition['CaseId'] = intval($array['CaseId']);        }        elseif($array['BigCaseId'] && $array['select_type'] == 2){            $query_condition['BigCaseId'] = intval($array['BigCaseId']);        }        if($array['ChildId'] && $array['select_type'] == 2){            $query_condition['ChildId'] = intval($array['ChildId']);        }        if($array['ChannelId'] && $array['select_type'] == 3){            $query_condition['ChannelId'] = intval($array['ChannelId']);        }        if($array['start_date'] && $array['end_date']){            $query_condition['uptime'] = array('$gte'=>intval(strtotime($array['start_date'])),'$lte'=>intval(strtotime($array['end_date'])));        }                $table_name = 'kkyoo_action.UserAction';        //$total = $this->mongodb->get_var(        //    $table_name,        //    $query_condition,        //    array('COUNT')        //);        //if($total > 0) {            $page_arr = $this->showPage($total,20);            list($offset,$rows) = explode(',',$page_arr['limit']);            $limit = array('offset'=>$offset,'rows'=>$rows);            if($limit['offset'] < 1){                unset($limit['offset']);            }            $result = $this->mongodb->get_results(                $table_name,                $query_condition,                array(                    'sort'=>array('uptime'=>-1),                    'limit'=>$limit                )            );            foreach((array)$result as $key => $val){                $result[$key]['uptime'] = date('Y-m-d H:i:s',$val['uptime']);                $param = array(                    'param'=>array(                        "BigCaseId"=> $val['BigCaseId'],                        "CaseId"   => $val['CaseId'],                        "ParentId" => $val['ParentId'],                        "ChildId"  => $val['ChildId'],                    ),                    'extparam'=>array(                        "Tag" => "GetBusinessConfig",                    )                );                $ccs = httpPOST(CCS_API_PATH,$param);                $result[$key]['BigCaseName'] = $ccs['Result']['bigcase_name'];                $result[$key]['CaseName'] = $ccs['Result']['case_name'];                $result[$key]['ParentName'] = $ccs['Result']['parent_name'];                $result[$key]['ChildName'] = $ccs['Result']['child_name'];            }            $page_arr = $this->showPage($key+1,20);            $list['list'] = $result;            $list['page'] = $page_arr['page'];        //}        return array('Flag'=>100,'FlagString'=>'行为流水查看','Result'=>$list);    }/*nodejs调用    public function actList($array){        if(is_array($array) && !empty($array)) {            foreach(($array) as $key => $val) {                if($key == 'ChannelId' && $val > 0) {                    $query_condition .= '"'.$key.'":'.(int)$val.',';                }                if($key == 'key_word' && !empty($val)) {                    //$query_condition .= '"Desc":/.*'.urlencode($val).'./i,';                }                if(in_array($key,array('BigCaseId','CaseId','ParentId','ChildId')) && !empty($val)) {                    $query_condition .= '"'.$key.'":'.(int)$val.',';                }            }            if($array['start_date'] > 0 && $array['end_date'] >0){            $query_condition .= '"uptime":{"$gte":'.strtotime($array['start_date']).',"$lte":'.strtotime($array['end_date']).'},';            }            if($array['uin_type'] == 1 && $array['uin'] > 0){                $query_condition .= '"Uin":'.(int)$array['uin'].',';            }elseif($array['uin_type'] == 2 && $array['uin'] > 0){                $query_condition .= '"TargetUin":'.(int)$array['uin'].',';            }        }        if(!empty($query_condition)){            $query_condition = rtrim($query_condition,',');        }else{            $query_condition = '';        }        $table_name = 'UserAction';        //$mongo_array = array(        //	'db'=>'kkyoo_action',        //	'table'=>$table_name,        //	'total'=>array('_id'),        //	'where'=>$query_condition,        //	'definevar'=>true        //);        $mongo_json = '{"db":"kkyoo_action","table":"'.$table_name.'","total":[],"where":{'.$query_condition.'}}';        $page = (int)$_GET['page'];        $limit = 20;        $skip = (($page>1 ? $page -1 :0))*$limit;        //$result_array = array(        //	'db'=>'kkyoo_action',        //	'table'=>$table_name,        //	'fields'=>array(),        //	'where'=>$query_condition,        //	'option'=>array(        //		'limit'=>$limit,        //		'skip'=>$skip,        //		'sort'=>array(        //			array('_id','desc')        //		)        //	),        //	'definevar'=>true        //);        $result_json = '{"db":"kkyoo_action","table":"'.$table_name.'","fields":[],"where":{'.$query_condition.'},"option":{"limit":"'.$limit.'","skip":"'.$skip.'","sort":[["uptime","desc"]]}}';                $list['node_total'] = socket_request(MONGO_API_PATH.'/?cmd='.$mongo_json);        $list['node_list'] = socket_request(MONGO_API_PATH.'/?cmd='.$result_json);        return $list;    }*/    private function showPage($total, $perpage = 10) {        require_once (dirname(dirname(dirname(dirname(__FILE__)))).'/library/page.class.php');        $page = new extpage(array (            'total' => $total,            'perpage' => $perpage        ));        $pageArr['page'] = $page->simple_page($total);        $pageArr['limit'] = $page->simple_limit();        unset ($page);        return $pageArr;    }}?>